# SPDX-License-Identifier: AGPL-3.0-or-later
# Oikos Bot Compose Configuration
#
# Usage with Vörðr/Podman:
#   podman-compose up -d
#   podman-compose logs -f oikos
#   podman-compose down

name: oikos

services:
  # ==========================================================================
  # Main Oikos Bot Service
  # ==========================================================================
  oikos:
    build:
      context: ..
      dockerfile: containers/Containerfile
    image: oikos:latest
    container_name: oikos
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      - PORT=3000
      - BOT_MODE=advisor
      - ANALYSIS_ENDPOINT=https://analyzer:8080/analyze
      - GITHUB_WEBHOOK_SECRET=${GITHUB_WEBHOOK_SECRET:-}
      - GITLAB_WEBHOOK_SECRET=${GITLAB_WEBHOOK_SECRET:-}
      - ARANGO_URL=https://arangodb:8529
      - VIRTUOSO_URL=https://virtuoso:8890/sparql
    depends_on:
      - arangodb
      - virtuoso
      - analyzer
    networks:
      - oikos-network
    healthcheck:
      test: ["CMD", "deno", "eval", "const r = await fetch('http://localhost:3000/health'); if (!r.ok) Deno.exit(1);"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ==========================================================================
  # Analysis Service (Haskell + OCaml analyzers)
  # ==========================================================================
  analyzer:
    build:
      context: ..
      dockerfile: containers/Containerfile
      target: runtime
    image: oikos-analyzer:latest
    container_name: oikos-analyzer
    restart: unless-stopped
    ports:
      - "8080:8080"
    environment:
      - PORT=8080
    networks:
      - oikos-network
    command: ["oikos-analyzer", "serve", "--port", "8080"]

  # ==========================================================================
  # Policy Engine (Datalog + DeepProbLog)
  # ==========================================================================
  policy-engine:
    build:
      context: ..
      dockerfile: containers/Containerfile.policy
    image: oikos-policy:latest
    container_name: oikos-policy
    restart: unless-stopped
    ports:
      - "8081:8081"
    environment:
      - PORT=8081
      - ARANGO_URL=https://arangodb:8529
      - VIRTUOSO_URL=https://virtuoso:8890/sparql
    depends_on:
      - arangodb
      - virtuoso
    networks:
      - oikos-network
    volumes:
      - policy-data:/app/data

  # ==========================================================================
  # ArangoDB (Graph + Document Database)
  # ==========================================================================
  arangodb:
    image: arangodb:3.11
    container_name: oikos-arangodb
    restart: unless-stopped
    ports:
      - "8529:8529"
    environment:
      - ARANGO_ROOT_PASSWORD=${ARANGO_ROOT_PASSWORD:-oikos}
      - ARANGO_NO_AUTH=${ARANGO_NO_AUTH:-0}
    volumes:
      - arangodb-data:/var/lib/arangodb3
      - ../databases/arangodb/schema.js:/docker-entrypoint-initdb.d/schema.js:ro
    networks:
      - oikos-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8529/_api/version"]
      interval: 30s
      timeout: 10s
      retries: 5

  # ==========================================================================
  # Virtuoso (RDF Triple Store + SPARQL)
  # ==========================================================================
  virtuoso:
    image: openlink/virtuoso-opensource-7:latest
    container_name: oikos-virtuoso
    restart: unless-stopped
    ports:
      - "8890:8890"
      - "1111:1111"
    environment:
      - DBA_PASSWORD=${VIRTUOSO_DBA_PASSWORD:-oikos}
      - SPARQL_UPDATE=true
      - DEFAULT_GRAPH=https://oikos.dev/knowledge
    volumes:
      - virtuoso-data:/database
      - ../databases/virtuoso/ontology.ttl:/opt/virtuoso-opensource/share/virtuoso/vad/ontology.ttl:ro
    networks:
      - oikos-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8890/sparql?query=ASK%20%7B%7D"]
      interval: 30s
      timeout: 10s
      retries: 5

  # ==========================================================================
  # Prometheus (Metrics)
  # ==========================================================================
  prometheus:
    image: prom/prometheus:latest
    container_name: oikos-prometheus
    restart: unless-stopped
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus-data:/prometheus
    networks:
      - oikos-network
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'

  # ==========================================================================
  # Grafana (Dashboard)
  # ==========================================================================
  grafana:
    image: grafana/grafana:latest
    container_name: oikos-grafana
    restart: unless-stopped
    ports:
      - "3001:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD:-oikos}
      - GF_USERS_ALLOW_SIGN_UP=false
    volumes:
      - grafana-data:/var/lib/grafana
      - ./grafana/provisioning:/etc/grafana/provisioning:ro
    depends_on:
      - prometheus
    networks:
      - oikos-network

# =============================================================================
# Networks
# =============================================================================
networks:
  oikos-network:
    driver: bridge

# =============================================================================
# Volumes
# =============================================================================
volumes:
  arangodb-data:
  virtuoso-data:
  policy-data:
  prometheus-data:
  grafana-data:
