# SPDX-License-Identifier: PMPL-1.0
# SPDX-FileCopyrightText: 2025 Jonathan D.A. Jewell
#
# Oikos Bot - Continuous Integration

name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions: read-all

jobs:
  rescript:
    name: ReScript Build
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Setup Node.js (for ReScript compiler)
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: bot-integration/package-lock.json

      - name: Setup Deno
        uses: denoland/setup-deno@e95548e56dfa95d4e1a28d6f422fafe75c4c26fb # v1.1.4
        with:
          deno-version: v1.x

      - name: Install ReScript compiler
        working-directory: bot-integration
        run: npm ci

      - name: Build ReScript
        working-directory: bot-integration
        run: deno task build:rescript

      - name: Cache Deno dependencies
        working-directory: bot-integration
        run: deno cache src/Oikos.res.js

      - name: Run tests
        working-directory: bot-integration
        run: deno task test || echo "No tests yet"

  haskell:
    name: Haskell Analyzer
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Setup Haskell
        uses: haskell-actions/setup@f9150cb1d140e9a9271700670baa38991e6fa25c # v2.6.3
        with:
          ghc-version: "9.4"
          cabal-version: "3.10"

      - name: Cache Cabal
        uses: actions/cache@8b402f58fbc84540c8b491a91e594a4576fec3d7 # v5.0.2
        with:
          path: |
            ~/.cabal/packages
            ~/.cabal/store
            analyzers/code-haskell/dist-newstyle
          key: cabal-${{ runner.os }}-ghc9.4-${{ hashFiles('analyzers/code-haskell/eco-analyzer.cabal') }}

      - name: Build Haskell analyzer
        working-directory: analyzers/code-haskell
        run: |
          cabal update
          cabal build all
        continue-on-error: true

  security:
    name: Security Checks
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@b6643a29fecd7f34b3597bc6acb0a98b03d33ff8 # v0.33.1
        with:
          scan-type: "fs"
          scan-ref: "."
          severity: "CRITICAL,HIGH"
          format: "sarif"
          output: "trivy-results.sarif"
        continue-on-error: true

      - name: Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@19b2f06db2b6f5108140aeb04014ef02b648f789 # v3.28.1
        with:
          sarif_file: "trivy-results.sarif"
        continue-on-error: true
