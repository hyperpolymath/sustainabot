# SPDX-License-Identifier: AGPL-3.0-or-later
# SPDX-FileCopyrightText: 2025 Jonathan D.A. Jewell
#
# Oikos Bot - Continuous Integration

name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions: read-all

jobs:
  rescript:
    name: ReScript Build
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Setup Node.js (for ReScript compiler)
        uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6.1.0
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: bot-integration/package-lock.json

      - name: Setup Deno
        uses: denoland/setup-deno@e95548e56dfa95d4e1a28d6f422fafe75c4c26fb # v1.1.4
        with:
          deno-version: v1.x

      - name: Install ReScript compiler
        working-directory: bot-integration
        run: npm ci

      - name: Build ReScript
        working-directory: bot-integration
        run: deno task build:rescript

      - name: Cache Deno dependencies
        working-directory: bot-integration
        run: deno cache src/Oikos.res.js

      - name: Run tests
        working-directory: bot-integration
        run: deno task test || echo "No tests yet"

  haskell:
    name: Haskell Analyzer
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Setup Haskell
        uses: haskell-actions/setup@0512451d82f3ca8c147db62e30464e7c4ca63d30 # v2.6.3
        with:
          ghc-version: "9.4"
          cabal-version: "3.10"

      - name: Cache Cabal
        uses: actions/cache@9255dc7a253b0ccc959486e2bca901246202afeb # v5.0.1
        with:
          path: |
            ~/.cabal/packages
            ~/.cabal/store
            analyzers/code-haskell/dist-newstyle
          key: cabal-${{ runner.os }}-ghc9.4-${{ hashFiles('analyzers/code-haskell/eco-analyzer.cabal') }}

      - name: Build Haskell analyzer
        working-directory: analyzers/code-haskell
        run: |
          cabal update
          cabal build all
        continue-on-error: true

  security:
    name: Security Checks
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@b6643a29fecd7f34b3597bc6acb0a98b03d33ff8 # v0.33.1
        with:
          scan-type: "fs"
          scan-ref: "."
          severity: "CRITICAL,HIGH"
          format: "sarif"
          output: "trivy-results.sarif"
        continue-on-error: true

      - name: Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@5d4e8d1aca955e8d8589aabd499c5cae939e33c7 # v3.28.1
        with:
          sarif_file: "trivy-results.sarif"
        continue-on-error: true
